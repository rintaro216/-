# おんぷタイム 予約システム - プロジェクト状況

最終更新日: 2025年10月21日

## 📋 プロジェクト概要
音楽スタジオの予約管理システム
- **エリア**: おんぷ館（7スタジオ）、みどり楽器（3スタジオ）
- **利用者**: 学生・一般（料金差あり）
- **管理者**: スタッフ用管理画面
- **総コード行数**: 約3,500行以上
- **開発フェーズ**: Phase 1（基本予約フロー）完全実装済み

---

## ✅ 実装済み機能

### 1. ユーザー予約フロー（7ページ）
- ✅ **Home.jsx** (159行) - ランディングページ
  - ニューススライダー（Swiper統合）
  - エリア紹介カード（Framer Motionアニメーション）
  - 特徴セクション（3つのメリット）
  - 利用フローの6ステップ表示
- ✅ **AreaSelect.jsx** - エリア選択（おんぷ館/みどり楽器）
- ✅ **DateSelect.jsx** (265行) - 日付・時刻選択
  - date-fns統合の月間カレンダー
  - 時間帯ごとの空室状況表示（○△×）
  - 当日予約の禁止処理
- ✅ **StudioSelect.jsx** (188行) - スタジオ選択
  - 10スタジオの詳細表示
  - 空室状況のリアルタイム判定
  - ブロック済みスタジオの非表示
  - 設備・特徴・料金の表示
- ✅ **UserTypeSelect.jsx** - 利用者区分選択（学生/一般で料金変動）
- ✅ **ReservationForm.jsx** (272行) - 予約者情報入力
  - バリデーション（名前・電話・メール）
  - 利用規約同意チェック
  - ローディング状態表示
- ✅ **ReservationComplete.jsx** (194行) - 予約完了画面
  - 予約番号表示（OP-YYYYMMDD-XXX形式）
  - 予約内容の最終確認
  - アクセス情報・注意事項表示

### 2. 管理画面（6ページ）

#### **AdminLogin.jsx** (142行)
- ✅ Supabase Auth統合
- ✅ メール/パスワード認証
- ✅ localStorage に isAdmin フラグ保存
- ✅ グラデーション背景のモダンデザイン

#### **AdminDashboard.jsx** (204行)
- ✅ ログアウト機能
- ✅ 統計表示：今日の予約数、今週の予約数、稼働スタジオ数
- ✅ 4つのメニュー（予約管理、スタジオ管理、営業時間、統計）
- ✅ 実装予定機能のdisabledフラグ表示

#### **ReservationManagement.jsx** (722行) - 最も機能豊富
- ✅ 予約一覧表示（Supabaseから取得）
- ✅ 複合フィルタリング
  - テキスト検索（名前・電話・予約番号）
  - 日付フィルタ
  - エリアフィルタ
  - ステータスフィルタ
- ✅ **予約詳細モーダル**
  - 予約カードクリックで全情報表示
  - 色分けセクション（青：予約情報、緑：顧客情報）
  - システム情報表示（作成日時、キャンセル日時）
- ✅ **予約編集モーダル**
  - 日付・時刻変更
  - スタジオ変更（エリアに応じて自動フィルタ）
  - 顧客情報は参考表示（編集不可）
- ✅ 予約キャンセル機能
- ✅ **CSVエクスポート機能**
  - BOM付きUTF-8エンコード（Excel文字化け対策）
  - タイムスタンプ付きファイル名
  - フィルタ結果のみエクスポート
- ✅ スタジオ名の表示改善（IDではなくdisplay_name表示）
- ✅ 再読み込みボタン

#### **StudioManagementUnified.jsx** (111行)
- ✅ タブインターフェース（スタジオ設定/営業時間）
- ✅ 各機能コンポーネントを埋め込み表示

#### **StudioManagement.jsx** (274行)
- ✅ スタジオ稼働/休止トグル機能
- ✅ エリアフィルタ
- ✅ 統計表示（全体、稼働中、休止中）
- ✅ StudioCard コンポーネント（料金・設備・アイコン表示）

#### **BusinessHoursManagement.jsx** (1029行) - 最も複雑
- ✅ **基本設定タブ（曜日ベース）**
  - スタジオごと・曜日ごとに30分単位でビジュアル編集
  - **アコーディオン機能**（折りたたみ表示でスクロール削減）
  - **一括操作ボタン**
    - 全て利用可能
    - 全て利用不可
    - 9-18時を利用可能
  - ドラッグ機能で複数時間帯の一括選択
  - weekly_blocked_slots テーブルと連携
- ✅ **カレンダータブ（日付ごと設定）**
  - 月間カレンダー表示（date-fns統合）
  - 選択日の時間帯を個別設定
  - **一括操作ボタン**（全て予約可能/不可、9-18時設定）
  - blocked_slots テーブルと連携
- ✅ 30分単位の時間管理（9:00-22:00 = 26コマ）

### 3. 共通コンポーネント（4つ）
- ✅ **Header.jsx** (35行)
  - ロゴとサイトタイトル
  - ナビゲーション（お知らせ、予約ボタン）
  - sticky配置（画面上部固定）
- ✅ **Footer.jsx** (70行)
  - 3列グリッド：おんぷ館情報、アクセス、ご利用案内
  - 連絡先：電話052-836-0811、住所、営業時間
  - リンク：利用規約、キャンセルポリシー、FAQ、お問い合わせ
- ✅ **NewsSlider.jsx** (44行)
  - Swiper ライブラリ統合（Autoplay, Pagination, Navigation）
  - 5秒の自動スライド
  - グラデーション背景
- ✅ **ProtectedRoute.jsx** (11行)
  - localStorage の isAdmin フラグで管理画面アクセス制御
  - 未認証時は /admin/login へリダイレクト

### 4. サービス層
- ✅ **reservationService.js** (280行)
  - `generateReservationNumber()` - 予約番号生成（OP-YYYYMMDD-XXX形式）
  - `checkAvailability()` - 特定日時のスタジオ空室状況確認
  - `getAvailabilityByDate()` - 1日の全時間帯の空室状況一括取得
  - `createReservation()` - 新規予約作成（Supabaseへ保存）
  - `cancelReservation()` - 予約キャンセル（ステータス更新）
  - Supabase未設定時のダミーデータ対応
- ✅ **supabase.js**
  - Supabase クライアント初期化
  - 環境変数管理（VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY）
  - `isSupabaseConfigured()` 関数で接続状態判定

### 5. データマスタ
- ✅ **studioData.js** (122行)
  - おんぷ館：7スタジオ（グランドピアノ、アップライト、防音室）
  - みどり楽器：3スタジオ（ドラム室A/B、ギター・ベース室）
  - 設備、料金（一般/生徒）、特徴、アイコン
- ✅ **newsData.js** (47行)
  - 5件のお知らせサンプルデータ

### 6. データベース設計
- ✅ **reservations** - 予約テーブル
  - 予約番号、エリア、スタジオID、日時、顧客情報、料金、ステータス
- ✅ **studios** - スタジオテーブル
  - ID、エリア、表示名、アイコン、稼働状態、料金、設備、特徴
- ✅ **blocked_slots** - 日付別ブロックテーブル
  - 特定日の時間帯ブロック（臨時休業など）
- ✅ **weekly_blocked_slots** - 曜日別定期ブロックテーブル
  - 毎週繰り返される時間帯ブロック（例：毎週月曜は休み）
- ✅ **business_hours** - 営業時間テーブル
  - エリアごと・曜日ごとの営業時間
- ✅ **RLSポリシーの修正**
  - 予約作成時の"new row violates row-level security policy"エラー解消
  - 全操作（INSERT/SELECT/UPDATE/DELETE）を許可

---

## 🚫 不要な機能（実装しない）
- ❌ 休業日管理（営業時間管理に統合済み）
- ❌ 統計・レポート機能（現在の機能で十分）

---

## 🔧 技術スタック

### フロントエンド
- **React**: 19.1.1
- **React Router**: 6.28.0
- **Tailwind CSS**: 3.4.15
  - カスタム色定義（primary-orange: #FF8C42, primary-green: #4CAF50）
  - カスタムグリッド（grid-cols-26 for 30分単位表示）
- **Framer Motion**: 11.15.0（アニメーション）
- **Swiper**: 11.1.1（カルーセル）
- **React Icons**: 5.4.0（FaIcons）
- **date-fns**: 4.1.0（日本語ロケール対応）

### バックエンド
- **Supabase**: 2.75.0
  - PostgreSQL データベース
  - Row Level Security (RLS)
  - 認証（Auth）

### ビルドツール
- **Vite**: 7.1.9
- **ESLint**: 9.17.0

### デザインパターン
- コンポーネントベース設計
- サービス層分離（reservationService.js）
- データ層分離（studioData.js, newsData.js）
- ProtectedRoute パターン

---

## 📁 ファイル構造

```
D:\claude\onpu-time
├── src/
│   ├── pages/
│   │   ├── Home.jsx (159行) ......................... ホームページ
│   │   ├── AreaSelect.jsx ........................... エリア選択
│   │   ├── DateSelect.jsx (265行) ................... 日時選択
│   │   ├── StudioSelect.jsx (188行) ................. スタジオ選択
│   │   ├── UserTypeSelect.jsx ....................... 利用者区分選択
│   │   ├── ReservationForm.jsx (272行) .............. 予約フォーム
│   │   ├── ReservationComplete.jsx (194行) .......... 予約完了
│   │   └── admin/
│   │       ├── AdminLogin.jsx (142行) ............... 管理者ログイン
│   │       ├── AdminDashboard.jsx (204行) .......... ダッシュボード
│   │       ├── ReservationManagement.jsx (722行) ... 予約管理★
│   │       ├── StudioManagementUnified.jsx (111行) . スタジオ総合管理
│   │       ├── StudioManagement.jsx (274行) ........ スタジオ管理
│   │       └── BusinessHoursManagement.jsx (1029行) 営業時間管理★
│   ├── components/
│   │   ├── Header.jsx (35行) ....................... グローバルヘッダー
│   │   ├── Footer.jsx (70行) ....................... グローバルフッター
│   │   ├── NewsSlider.jsx (44行) ................... ニューススライダー
│   │   └── ProtectedRoute.jsx (11行) ............... ルート保護
│   ├── services/
│   │   └── reservationService.js (280行) .......... 予約サービス★
│   ├── lib/
│   │   └── supabase.js ............................. Supabase設定
│   ├── data/
│   │   ├── studioData.js (122行) .................. スタジオマスタ
│   │   └── newsData.js (47行) ..................... ニュースデータ
│   ├── App.jsx ..................................... ルーティング
│   └── main.jsx .................................... エントリーポイント
├── SUPABASE_SCHEMA_UPDATE.sql ...................... スキーマ更新
├── SUPABASE_WEEKLY_BLOCKED_SLOTS.sql ............... 曜日別ブロック
├── SUPABASE_BUSINESS_HOURS.sql ..................... 営業時間
├── SUPABASE_RESERVATIONS_RLS_FIX.sql ............... RLS修正★
├── PROJECT_STATUS.md ............................... このファイル★
├── package.json .................................... 依存パッケージ
├── tailwind.config.js .............................. Tailwind設定
└── vite.config.js .................................. Vite設定

★ = 特に重要/最近更新
```

---

## 🐛 既知の問題・解決済み

### 解決済み
- ✅ 予約作成時のRLSエラー → ポリシー修正で解決
- ✅ 時間帯表示が緑の塊になる問題 → Flexレイアウトに変更して解決
- ✅ スタジオIDが表示される問題 → 表示名を取得して解決
- ✅ 営業時間管理のスクロール量が多い → アコーディオンで解決
- ✅ 時間帯ブロックページの重複 → 営業時間管理に統合して解決

---

## 🎯 次回のセッション開始時の確認事項

### 1. 開発サーバーの起動
```bash
cd D:/claude/onpu-time
npm run dev
```
- 通常: http://localhost:5173/
- ポート使用中の場合: http://localhost:5174/ など

### 2. 管理画面のアクセス
- URL: http://localhost:5173/admin/login
- ログイン後、以下が利用可能：
  - 予約管理（編集・詳細・CSV機能）
  - スタジオ管理
  - 営業時間管理（曜日別・日付別）

### 3. 現在の状態
- ✅ 予約フロー: 正常動作
- ✅ 予約管理: 完全機能（編集・詳細・CSV）
- ✅ 営業時間管理: 完全機能（アコーディオン・一括操作）
- ✅ データベース: RLSポリシー修正済み

---

## 💡 今後の開発候補（必要に応じて）

### 優先度低
- メール通知機能（予約確定時）
- ユーザー側のマイページ
- 予約のリマインダー機能
- より詳細な統計・分析

---

## 📝 開発履歴

### Phase 1: 基本予約システム構築（完了）
- ✅ ユーザー予約フロー（7ページ）実装
- ✅ 管理画面基盤（認証、ダッシュボード）実装
- ✅ Supabase連携
- ✅ スタジオマスタデータ作成（10スタジオ）
- ✅ 基本的な予約管理機能

### Phase 1.5: UI/UX改善（完了）
- ✅ Framer Motion アニメーション追加
- ✅ Swiper ニューススライダー統合
- ✅ レスポンシブデザイン対応
- ✅ カラースキーム統一

### Phase 2: 管理機能強化（2025年10月21日完了）

#### 予約管理の大幅強化
1. **編集機能**
   - モーダル形式で日時・スタジオ変更可能
   - エリア変更時のスタジオ自動フィルタ
   - リアルタイムバリデーション

2. **詳細表示**
   - 予約カードクリック→全情報モーダル表示
   - 色分けセクション（青：予約、緑：顧客、灰：システム）
   - モーダルから直接編集・キャンセル可能

3. **CSVエクスポート**
   - BOM付きUTF-8エンコード（Excel文字化け対策）
   - フィルタ結果のみエクスポート
   - タイムスタンプ付きファイル名

4. **表示改善**
   - スタジオID → 表示名（例：dr-a → ドラム室A）
   - 複合フィルタリング強化

#### 営業時間管理の大幅改善
1. **アコーディオンUI**
   - スタジオを折りたたみ表示
   - スクロール量を大幅削減
   - クリーンなインターフェース

2. **一括操作機能**
   - 全て利用可能/不可ボタン
   - 9-18時一括設定ボタン
   - 曜日ベース・日付ベース両方に実装

3. **時間帯ブロック統合**
   - 独立していた「時間帯ブロックページ」を削除
   - 営業時間管理に機能統合
   - weekly_blocked_slots テーブル新規作成

#### バグ修正
- ✅ 予約作成時のRLSエラー解決
  - エラー: "new row violates row-level security policy"
  - 原因: RLSポリシーでINSERT権限が不足
  - 解決: SUPABASE_RESERVATIONS_RLS_FIX.sql 実行
- ✅ 時間帯表示が緑の塊になる問題
  - 原因: grid-cols-26 + aspect-square で極小サイズ
  - 解決: Flexレイアウト + 固定サイズ（w-12 h-12）に変更
- ✅ スタジオIDが表示される問題
  - 解決: studios テーブルからdisplay_name取得

### 重要な技術的実装
1. **30分単位の時間管理システム**
   - 9:00-22:00 = 26コマ
   - インデックス計算式実装
   - ドラッグ選択機能

2. **予約番号生成アルゴリズム**
   - フォーマット: OP-YYYYMMDD-XXX
   - 日付ベースの連番管理

3. **ダミーデータ対応**
   - Supabase未設定時も動作
   - 開発・本番の自動切り替え

---

## 🔄 このファイルの使い方

### Claude Code に指示する際
```
「PROJECT_STATUS.mdを確認して、現在の進捗状況を教えてください」
「PROJECT_STATUS.mdを更新して、今日実装した機能を記録してください」
```

### 毎回のセッション開始時
1. このファイルを読んで現在の状況を把握
2. 開発サーバーが起動しているか確認
3. 必要に応じて前回の作業内容を確認

### セッション終了時
1. 実装した機能をこのファイルに追記
2. 新しい問題があれば「既知の問題」に記録
3. 次回の作業予定があれば「今後の開発候補」に追記

---

**このファイルは常に最新の状態に保ち、プロジェクトの「現在地」を示すドキュメントとして活用してください。**
